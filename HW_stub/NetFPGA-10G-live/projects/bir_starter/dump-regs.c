#include <sys/ioctl.h>
#include <err.h>
#include <errno.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdint.h>
#include <string.h>

#include "sw/host/reg_defines.h"

#define	NF10_DEV_NODE			"/dev/nf10"
#define	NF10_IOCTL_CMD_READ_STAT	(SIOCDEVPRIVATE+0)
#define	NF10_IOCTL_CMD_WRITE_REG	(SIOCDEVPRIVATE+1)
#define	NF10_IOCTL_CMD_READ_REG		(SIOCDEVPRIVATE+2)

#define	DUMP_REG(r)							\
	do {								\
		uint32_t v;						\
									\
		v = rdaxi((r));						\
		printf("0x%08x (%-70s) = 0x%08x\n", (r), #r, v);	\
	} while(0)

static int dd;

static uint32_t
rdaxi(uint32_t addr)
{
	uint64_t r;
	int rc;

	r = addr;
	rc = ioctl(dd, NF10_IOCTL_CMD_READ_REG, &r);
	if (rc < 0)
		err(2, "Error: ioctl(NF10_IOCTL_CMD_READ_REG) 0x%08x", addr);

	return (r & 0xffffffff);
}

static void
wraxi(uint32_t addr, uint32_t val)
{
	uint64_t r;
	int rc;

	r = ((uint64_t)addr << 32) | (uint64_t)val;
	rc = ioctl(dd, NF10_IOCTL_CMD_WRITE_REG, &r);
	if (rc < 0)
		err(3, "Error: ioctl(NF10_IOCTL_CMD_WRITE_REG) 0x%16jx", r);
}

static void
dump_regs(void)
{

	/* MAC addresses. */
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_MAC_0_LOW);
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_MAC_0_HIGH);
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_MAC_1_LOW);
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_MAC_1_HIGH);
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_MAC_2_LOW);
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_MAC_2_HIGH);
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_MAC_3_LOW);
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_MAC_3_HIGH);

	/* Statistics. */
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_PKT_DROPPED_WRONG_DST_MAC);
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_PKT_SENT_CPU_LPM_MISS);
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_PKT_SENT_CPU_ARP_MISS);
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_PKT_SENT_CPU_NON_IP);
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_PKT_DROPPED_CHECKSUM);
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_PKT_FORWARDED);
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_PKT_SENT_CPU_DEST_IP_HIT);
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_PKT_SENT_TO_CPU_BAD_TTL);
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_PKT_SENT_CPU_OPTION_VER);
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_PKT_SENT_FROM_CPU);
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_PKT_ARP);
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_PKT_OSPF);
	DUMP_REG(XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_PKT_IP);
}

int
main(int argc, char *argv[])
{

	dd = open(NF10_DEV_NODE, O_RDWR);
	if (dd < 0)
		err(1, "Failed to open %s", NF10_DEV_NODE);

	dump_regs();

	return (0);
}

#if 0
/* Definitions for peripheral NF10_ROUTER_OUTPUT_PORT_LOOKUP_0 */
#define XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_ROUTE_TABLE_DEPTH 32
#define XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_ARP_TABLE_DEPTH 32
#define XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_DST_IP_FILTER_TABLE_DEPTH 32

#define XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_RESET_CNTRS 0x76800000

#define XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_BAR1_BASEADDR 0x74800000
#define XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_BAR1_HIGHADDR 0x7480FFFF

#define XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_LPM_IP 0x74808000
#define XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_LPM_IP_MASK 0x74808004
#define XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_LPM_NEXT_HOP_IP 0x74808008
#define XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_LPM_OQ 0x7480800c
#define XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_LPM_WR_ADDR 0x74808010
#define XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_LPM_RD_ADDR 0x74808014
#define XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_ARP_IP 0x74804000
#define XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_ARP_MAC_LOW 0x74804004
#define XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_ARP_MAC_HIGH 0x74804008
#define XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_ARP_WR_ADDR 0x7480400c
#define XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_ARP_RD_ADDR 0x74804010
#define XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_FILTER_IP 0x74801000
#define XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_FILTER_WR_ADDR 0x74801004
#define XPAR_NF10_ROUTER_OUTPUT_PORT_LOOKUP_0_FILTER_RD_ADDR 0x74801008
#endif
